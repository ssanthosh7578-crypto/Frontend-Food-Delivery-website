import { useState, useRef } from 'react'
import { Button } from "/components/ui/button"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "/components/ui/card"
import { Input } from "/components/ui/input"
import { Label } from "/components/ui/label"
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "/components/ui/select"
import { X } from "lucide-react"

type Resume = {
  id: string
  fileName: string
  name: string
  experience: number
  education: string
  skills: string[]
  content: string
}

export default function ResumeScreening() {
  const [resumes, setResumes] = useState<Resume[]>([])
  const [filteredResumes, setFilteredResumes] = useState<Resume[]>([])
  const [selectedResume, setSelectedResume] = useState<Resume | null>(null)
  const [filters, setFilters] = useState({
    keywords: '',
    minExperience: '',
    education: 'any' // Changed from empty string to 'any'
  })
  const fileInputRef = useRef<HTMLInputElement>(null)

  // Simulate extracting data from uploaded files
  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files
    if (!files) return

    const newResumes: Resume[] = []
    
    Array.from(files).forEach((file) => {
      const fileName = file.name
      const fileType = fileName.split('.').pop()?.toLowerCase()
      
      const mockResume: Resume = {
        id: Math.random().toString(36).substring(2, 9),
        fileName,
        name: Candidate ${Math.floor(Math.random() * 1000)},
        experience: Math.floor(Math.random() * 15),
        education: ['High School', 'Bachelor', 'Master', 'PhD'][Math.floor(Math.random() * 4)],
        skills: ['JavaScript', 'React', 'Node.js', 'Python', 'Java', 'SQL'].slice(0, Math.floor(Math.random() * 4) + 1),
        content: This is a simulated ${fileType} resume content for ${fileName}. It contains skills like ${['JavaScript', 'React', 'Node.js', 'Python', 'Java', 'SQL'][Math.floor(Math.random() * 6)]} and ${['teamwork', 'leadership', 'communication', 'problem-solving'][Math.floor(Math.random() * 4)]} skills.
      }
      
      newResumes.push(mockResume)
    })

    setResumes([...resumes, ...newResumes])
    setFilteredResumes([...resumes, ...newResumes])
    if (fileInputRef.current) fileInputRef.current.value = ''
  }

  const applyFilters = () => {
    let results = [...resumes]
    
    if (filters.keywords) {
      const keywords = filters.keywords.toLowerCase().split(',')
      results = results.filter(resume => 
        keywords.some(keyword => 
          resume.skills.some(skill => skill.toLowerCase().includes(keyword.trim())) ||
          resume.content.toLowerCase().includes(keyword.trim())
        )
      )
    }
    
    if (filters.minExperience) {
      results = results.filter(resume => 
        resume.experience >= parseInt(filters.minExperience)
      )
    }
    
    // Changed to check for 'any' instead of empty string
    if (filters.education !== 'any') {
      results = results.filter(resume => 
        resume.education === filters.education
      )
    }
    
    setFilteredResumes(results)
  }

  const handleFilterChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFilters({
      ...filters,
      [e.target.name]: e.target.value
    })
  }

  const resetFilters = () => {
    setFilters({
      keywords: '',
      minExperience: '',
      education: 'any' // Changed from empty string to 'any'
    })
    setFilteredResumes(resumes)
  }

  return (
    <div className="min-h-screen bg-gray-50 p-4 md:p-8">
      <Card className="w-full max-w-6xl mx-auto">
        <CardHeader>
          <CardTitle className="text-2xl">Resume Screening App</CardTitle>
          <CardDescription>Upload, filter, and review resumes</CardDescription>
        </CardHeader>
        
        <CardContent className="space-y-6">
          {/* Upload Section */}
          <div className="space-y-2">
            <Label htmlFor="resume-upload">Upload Resumes (PDF, DOC, TXT)</Label>
            <div className="flex gap-2">
              <Input
                id="resume-upload"
                type="file"
                ref={fileInputRef}
                onChange={handleFileUpload}
                accept=".pdf,.doc,.docx,.txt"
                multiple
                className="w-full"
              />
              <Button variant="outline" onClick={() => fileInputRef.current?.click()}>
                Browse
              </Button>
            </div>
            {resumes.length > 0 && (
              <p className="text-sm text-gray-500">
                {resumes.length} resume{resumes.length !== 1 ? 's' : ''} uploaded
              </p>
            )}
          </div>

          {/* Filter Section */}
          <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="space-y-2">
                <Label htmlFor="keywords">Keywords (comma separated)</Label>
                <Input
                  id="keywords"
                  name="keywords"
                  value={filters.keywords}
                  onChange={handleFilterChange}
                  placeholder="e.g. React, JavaScript"
                />
              </div>
              
              <div className="space-y-2">
                <Label htmlFor="minExperience">Minimum Experience (years)</Label>
                <Input
                  id="minExperience"
                  name="minExperience"
                  type="number"
                  value={filters.minExperience}
                  onChange={handleFilterChange}
                  placeholder="e.g. 5"
                />
              </div>
              
              <div className="space-y-2">
                <Label htmlFor="education">Education Level</Label>
                <Select
                  value={filters.education}
                  onValueChange={(value) => setFilters({...filters, education: value})}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select education" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="any">Any Education</SelectItem>
                    <SelectItem value="High School">High School</SelectItem>
                    <SelectItem value="Bachelor">Bachelor's Degree</SelectItem>
                    <SelectItem value="Master">Master's Degree</SelectItem>
                    <SelectItem value="PhD">PhD</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
            
            <div className="flex gap-2">
              <Button onClick={applyFilters}>Apply Filters</Button>
              <Button variant="outline" onClick={resetFilters}>
                Reset Filters
              </Button>
            </div>
          </div>

          {/* Results Section */}
          <div className="space-y-4">
            <div className="flex justify-between items-center">
              <h3 className="font-semibold">
                {filteredResumes.length} Resume{filteredResumes.length !== 1 ? 's' : ''} Found
              </h3>
            </div>
            
            {filteredResumes.length === 0 ? (
              <div className="text-center py-8 text-gray-500">
                No resumes match your filters
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {filteredResumes.map((resume) => (
                  <Card 
                    key={resume.id} 
                    className="cursor-pointer hover:bg-gray-50 transition-colors"
                    onClick={() => setSelectedResume(resume)}
                  >
                    <CardHeader>
                      <CardTitle className="text-lg">{resume.name}</CardTitle>
                      <CardDescription>{resume.fileName}</CardDescription>
                    </CardHeader>
                    <CardContent>
                      <div className="space-y-2">
                        <div>
                          <span className="font-medium">Experience:</span> {resume.experience} years
                        </div>
                        <div>
                          <span className="font-medium">Education:</span> {resume.education}
                        </div>
                        <div>
                          <span className="font-medium">Skills:</span> {resume.skills.join(', ')}
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Resume Detail Modal */}
      {selectedResume && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <Card className="w-full max-w-3xl max-h-[90vh] overflow-hidden">
            <CardHeader className="relative">
              <CardTitle>{selectedResume.name}</CardTitle>
              <CardDescription>{selectedResume.fileName}</CardDescription>
              <Button
                variant="ghost"
                size="icon"
                className="absolute top-4 right-4"
                onClick={() => setSelectedResume(null)}
              >
                <X className="h-4 w-4" />
              </Button>
            </CardHeader>
            <CardContent className="overflow-y-auto max-h-[60vh] space-y-4">
              <div className="space-y-2">
                <h4 className="font-semibold">Candidate Information</h4>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-500">Experience</p>
                    <p>{selectedResume.experience} years</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-500">Education</p>
                    <p>{selectedResume.education}</p>
                  </div>
                </div>
              </div>
              
              <div className="space-y-2">
                <h4 className="font-semibold">Skills</h4>
                <div className="flex flex-wrap gap-2">
                  {selectedResume.skills.map((skill) => (
                    <span key={skill} className="px-3 py-1 bg-gray-100 rounded-full text-sm">
                      {skill}
                    </span>
                  ))}
                </div>
              </div>
              
              <div className="space-y-2">
                <h4 className="font-semibold">Resume Content</h4>
                <div className="bg-gray-50 p-4 rounded whitespace-pre-wrap">
                  {selectedResume.content}
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  )
}